// x64dbg script to dump the raw Emotet DLL being distributed via OneNote files.
// Author: Leandro Fr√≥es
// Date: 2023-03-17
// Reference: 
// https://www.malware-traffic-analysis.net/2023/03/16/index.html
// https://blog.cyble.com/2023/03/17/recent-emotet-spam-campaign-utilizing-new-tactics/

bpc
bphc
bpmc

// Seems one of the final stages is executed via an user APC routine so we break here
bp ZwQueueApcThread
run

// A struct is passed via "ApcArgument1" and the 3rd field is a pointer to the raw DLL base address
SizeOfType void*
set $offset, $result * 2
set $base, [r8 + $offset]

// Here we get the size of the whole memory region. Since it's aligned on a page size boundary it would be a bit bigger than the original disk size
set $size, mem.size($base)

// Simple check to make sure the collected region starts with "MZ"
cmp word($base), 5a4d
jne exit

// Simple region size check
cmp $size, 15000
jbe exit

// Dump the memory region to the x64dbg directory. Make sure to change it if you want to dump in another location
savedata :memdump:, $base, $size

exit:
ret

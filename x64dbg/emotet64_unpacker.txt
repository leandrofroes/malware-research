// x64dbg script to unpack Emotet DLL before being mapped to memory and dumps it to a file.
// Author: Leandro FrÃ³es
// Date: 2023-03-13

// Hashes:
// 221608d1df1262559e6416acb37d114b0e6c4308e30fcde50b979548f64d709f
// 2112b5695e7bbe910a6efbab32332027a7fd6384f54c55c6e61a26812ad47e6d
// e34f283e6c42994ac9075cde8a341480f9d0a8f85097f8de3b6b4a959bf8c2c9
// 9b3119b6183eea08a6934736766f611e44ca00c0ae06aa890cbbbc57b83e6819
// 17278c375e4191ab84b5fff5d15a587f8d0b4a47111d0d9fa077fc6ec0e3d6fb
// 672a1e5a8a0d30687d3510672086e9ca7a29deff46b8a63dd7b7ba6149a01b42
// 38136a459b33a78c7e23691c880cb25ad463f5d615cf85cb8ceecda4e7f9ebc4
// fbe4c084d44a1b42840ece71b97198bae8ac059311c382c4d8005e6c69e027f6
// f69f5abe3956b2dcb02592209f941d8bbd65630866da650e45d5d9c683d1e981
// 4c6682442c09628d31b0628976be2229243a444c333fa2f21587a09eecb66ff7
// 064d6af066c9ffe0b45cd09f7424a4865c6ec839f7786ead27f40bd0ca21a15b
// 6780fdcbeae81f470907367bb0d08a29738d0744344e31b3f125c3bbf139e872

// Remove all the breakpoints
bpc
bphc
bpmc

// Attempt to find the VirtualAlloc call that allocates memory for the raw Emotet DLL
bp VirtualAlloc
bpcond VirtualAlloc, arg.get(1) > 15000
run

// Get both it's return address and the allocated region size
set $region_size, arg.get(1)
rtr
set $image_base, cax

bpd

// Set VirtualProtect as a sentinel and run until the bp is hit to make sure the DLL content was already written to the allocated region
bp VirtualProtect
run

// Dumb attempt to make sure the allocated region contains a valid PE file
cmp word($image_base), 5a4d
jne exit

// Save the allocated region to a file. Make sure to change the path bellow to your path, otherwise it will be saved in the x64dbg directory
savedata :memdump:, $image_base, $region_size

exit:
ret
